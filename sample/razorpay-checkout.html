<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Razorpay Checkout - Example</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      body {
        font-family:
          system-ui,
          Segoe UI,
          Roboto,
          Helvetica,
          Arial,
          sans-serif;
        padding: 24px;
      }
    </style>
  </head>
  <body
    style="
      align-items: center;
      gap: 20px;
      justify-content: center;
      background: #000;
      color: #fff;
    "
  >
    <h2>Razorpay Checkout â€” Example</h2>
    <p>
      Click the button below to request a Razorpay Order from the local API and
      open Checkout.
    </p>

    <label
      >Order ID to pay: <input id="orderId" value="1" style="width: 80px"
    /></label>
    <label style="margin-left: 12px"
      >Name: <input id="customerName" value="Test User"
    /></label>
    <label style="margin-left: 12px"
      >Email: <input id="customerEmail" value="sandbox_user@example.com"
    /></label>
    <button id="pay">Pay with Razorpay</button>

    <pre
      id="log"
      style="
        background: #111;
        color: #fff;
        padding: 12px;
        margin-top: 12px;
        white-space: pre-wrap;
      "
    ></pre>

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
      const log = (v) => {
        document.getElementById("log").textContent +=
          "\n" + JSON.stringify(v, null, 2);
      };

      async function createOrder(orderId, customerName, customerEmail) {
        const res = await fetch("http://localhost:4000/api/payment/intent", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            orderId,
            provider: "razorpay",
            customerName,
            customerEmail,
            successUrl: "/checkout/success",
          }),
        });
        return res.json().then((body) => ({ status: res.status, body }));
      }

      async function verifyPayment(payload) {
        const res = await fetch(
          "http://localhost:4000/api/payment/razorpay/verify",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          },
        );
        return res.json().then((body) => ({ status: res.status, body }));
      }

      document.getElementById("pay").addEventListener("click", async () => {
        const orderId = Number(document.getElementById("orderId").value || 1);
        log({ step: "request-order", orderId });

        const customerName = document.getElementById("customerName").value;
        const customerEmail = document.getElementById("customerEmail").value;

        const orderResp = await createOrder(
          orderId,
          customerName,
          customerEmail,
        );
        log({ orderResp });

        if (![200, 201].includes(orderResp.status))
          return log({ error: "failed to create order" });

        const {
          keyId,
          checkoutId: order_id,
          internalOrderId,
          successUrl,
        } = orderResp.body;
        const options = {
          key: keyId,
          order_id,
          handler: async function (response) {
            log({ razorpay_response: response });

            // Send the payment details to the server for verification
            const verifyResp = await verifyPayment({
              razorpay_order_id: response.razorpay_order_id,
              razorpay_payment_id: response.razorpay_payment_id,
              razorpay_signature: response.razorpay_signature,
            });
            log({ verifyResp });

            // On successful verification redirect user to confirmation URL (internal order id)
            if (verifyResp && verifyResp.status === 200) {
              const redirectTo =
                (successUrl || "/checkout/success") +
                `?orderId=${internalOrderId || orderId}`;
              log({ redirectTo });
              window.location.href = redirectTo;
            }
          },
          modal: {
            ondismiss: function () {
              log({ dismissed: true });
            },
          },
        };

        const rzp = new Razorpay(options);
        rzp.open();
      });
    </script>
  </body>
</html>
