# Implementation Plan: Database Persistence Layer

**Branch**: `001-db-drizzle-pglite` | **Date**: 2026-01-26 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `specs/001-db-drizzle-pglite/spec.md`

**Note**: This template is filled in by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

This plan outlines the implementation of a database persistence layer using Drizzle ORM and PGlite. This will replace the current in-memory data storage, allowing data to persist across server restarts.

## Technical Context

**Language/Version**: TypeScript 5.8.3
**Primary Dependencies**: Fastify 5.6.1, Drizzle ORM, PGlite
**Storage**: PGlite
**Testing**: vitest
**Target Platform**: Node.js
**Project Type**: Single project (web backend)
**Performance Goals**: <50ms p95 for common database queries.
**Constraints**: The database will run in-process with the Node.js application.
**Scale/Scope**: The initial implementation is for a single-instance application.

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

- **Principle 1 & 2 (pnpm, file-based routing)**: **PASS**. The project already uses pnpm and a file-based routing structure, which will be maintained.
- **Principle 3 (zod)**: **PASS**. The project uses Zod. This plan will leverage `drizzle-zod` to generate Zod schemas from database schemas, reinforcing this principle.
- **Principle 4 (vitest)**: **NEEDS ACTION**. `vitest` is not currently a project dependency. It will be added as part of the implementation.

## Project Structure

### Documentation (this feature)

```text
specs/001-db-drizzle-pglite/
├── plan.md              # This file
├── research.md          # Research on Drizzle/PGlite best practices
├── data-model.md        # Data models for User and Post
├── quickstart.md        # Will not be generated for this feature
├── contracts/           # Will not be generated for this feature
└── tasks.md             # To be generated by /speckit.tasks
```

### Source Code (repository root)

```text
src/
├── db/
│   ├── index.ts         # Fastify plugin for DB connection
│   ├── schema.ts        # Drizzle table definitions
│   └── drizzle.config.ts # Config for drizzle-kit migrations
├── lib/
│   └── ...              # Existing libraries
├── routes/
│   └── ...              # Existing routes (will be updated to use DB)
└── ...
```

**Structure Decision**: The project will follow the existing single project structure. A new `src/db` directory will be created to encapsulate all database-related code, including the connection logic, schema definitions, and migration configuration.

## Complexity Tracking

> No violations of the constitution were identified that require justification.